<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Executor para ESD</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .terminal {
            background-color: #FFFFE0; /* cor marfim/cornsillk */
            color: #000000; /* preto forte */
            font-family: monospace;
            border: 2px solid #000000; /* contorno preto */
            padding: 10px;
            height: 480px; /* Aproximadamente 24 linhas de 20px */
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-word;
            line-height: 20px; /* Consistência no espaçamento */
        }
        .banner {
            background-color: #e6f2e6; /* Verde clarinho */
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        .banner img {
            height: 60px;
            margin-right: 15px;
        }
        .banner h1 {
            margin: 0;
            font-size: 1.8rem;
            color: #006400; /* Verde mais forte para o texto */
        }
        .form-area {
            background-color: #e6f0ff; /* Azul clarinho */
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        /* Novo estilo para o campo do nome do arquivo */
        .custom-file-name {
            background-color: #0d6efd; /* Azul padrão do Bootstrap btn-primary */
            color: white;
            border: 1px solid #0d6efd;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="p-4">

<div class="container">
    <!-- Banner com logo e título -->
    <div class="banner d-flex align-items-center">
        <img src="https://www.ifsc.edu.br/image/layout_set_logo?img_id=954802&t=1745683699182" alt="Logo IFSC">
        <h1>ADS: Estruturas de Dados</h1>
    </div>
    <div class="form-area">

        <h1 class="mb-4">Processa um arquivo</h1>

        <form id="uploadForm" class="mb-4" method="post">
            <div class="mb-3">
                <label for="fileInput" class="form-label">Selecione um arquivo de texto</label>
                <div class="input-group">
                    <label class="input-group-text btn btn-primaary custom-file-name" for="fileInput">Selecionar arquivo</label>
                    <input type="file" id="fileInput" name="file" class="form-control d-none" accept=".txt" required>
                    <input type="text" id="fileName" class="form-control" placeholder="Nenhum arquivo ainda" readonly>
                </div>
            </div>
            <button type="submit" class="btn btn-primary">Enviar</button>
        </form>


        <h2 class="mb-3">Resultado: </h2>
        <div id="duracaoInfo" class="mb-3 fw-bold" style="display: none;"></div>
<!--        <textarea id="serverResponse" class="form-control terminal" rows="10" readonly disabled></textarea>-->
        <div id="serverResponse" class="terminal"></div>
    </div>
</div>

<!-- Bootstrap Bundle JS (opcional) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Atualizar o nome do arquivo selecionado
    document.getElementById('fileInput').addEventListener('change', function() {
        const fileNameInput = document.getElementById('fileName');
        if (this.files.length > 0) {
            fileNameInput.value = this.files[0].name;
        } else {
            fileNameInput.value = '';
        }
    });

    // Parser básico de VT100
    function interpretVT100(text) {
        let output = "";
        let color = '#000000'; // preto inicial
        let i = 0;

        while (i < text.length) {
            if (text[i] === '\x1b') { // Se for um ESC
                if (text[i+1] === '[') {
                    let cmd = '';
                    i += 2;
                    while (i < text.length && (/[0-9;]/.test(text[i]))) {
                        cmd += text[i++];
                    }
                    const final = text[i++];

                    if (final === 'm') {
                        // Mudança de cor
                        const codes = cmd.split(';').map(Number);
                        codes.forEach(code => {
                            if (code === 0) {
                                color = '#000000'; // resetar: preto
                            } else if (code === 31) {
                                color = '#FF0000'; // vermelho
                            } else if (code === 32) {
                                color = '#008000'; // verde
                            } else if (code === 33) {
                                color = '#FFA500'; // amarelo
                            } else if (code === 34) {
                                color = '#0000FF'; // azul
                            } else if (code === 35) {
                                color = '#800080'; // magenta
                            } else if (code === 36) {
                                color = '#008080'; // ciano
                            } else if (code === 37) {
                                color = '#808080'; // cinza claro
                            }
                        });
                    } else if (final === 'J') {
                        // Limpar tela
                        output = "";
                    } else if (final === 'H') {
                        // Voltar para o início
                        output += '\n';
                    }
                } else {
                    i++;
                }
            } else if (text[i] === '\r') {
                i++; // ignorar
            } else if (text[i] === '\n') {
                output += '<br>';
                i++;
            } else {
                output += `<span style="color:${color}">${text[i++]}</span>`;
            }
        }

        return output;
    }

    document.getElementById('uploadForm').addEventListener('submit', async function(event) {
        event.preventDefault();

        const fileInput = document.getElementById('fileInput');
        const duracaoInfo = document.getElementById('duracaoInfo');
        const serverResponse = document.getElementById('serverResponse');

        if (fileInput.files.length === 0) {
            alert('Por favor, selecione um arquivo.');
            return;
        }

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        // Desabilita textarea antes de enviar
        // serverResponse.disabled = true;
        // serverResponse.value = '';
        serverResponse.innerText = '... aguardando resposta ...';

        try {
            const response = await fetch('/exec', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error('Erro ao enviar o arquivo');
            }

            const data = await response.json();

            // Atualizar a duração e o conteúdo
            duracaoInfo.style.display = 'block';
            duracaoInfo.textContent = `Duração da execução: ${data.duracao} segundos`;

            // Interpretar a resposta como VT100
            const interpreted = interpretVT100(data.conteudo);
            serverResponse.innerHTML = interpreted;
        } catch (error) {
            duracaoInfo.style.display = 'block';
            duracaoInfo.textContent = 'Erro durante o envio';
            serverResponse.value = 'Erro: ' + error.message;
        }
    });
</script>
</body>
</html>
